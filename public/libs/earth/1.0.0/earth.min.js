!function(){"use strict";var e,t,n,a=Math.floor(102),o=[NaN,NaN,null],i=[NaN,NaN,null],r=[0,0,0,0],l="▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫▫",s=µ.view(),c=µ.log(),d=(e=d3.select("#status"),t=d3.select("#progress"),n=l.length,{status:function(t){return e.classed("bad")?e:e.text(t)},error:function(t){var n=t.status?t.status+" "+t.message:t;switch(t.status){case-1:n="Server Down";break;case 404:n="No Data"}return c.error(t),e.classed("bad",!0).text(n)},reset:function(){return e.classed("bad",!1).text("")},progress:function(e){if(0<=e&&e<1){var a=Math.ceil(e*n),o="▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪".substr(0,a)+l.substr(0,n-a);return t.classed("invisible",!1).text(o)}return t.classed("invisible",!0).text("")}});function u(){return µ.newAgent().on({reject:d.error,fail:d.error})}var f=µ.buildConfiguration(globes,products.overlayTypes),v=function(){var e,t=null;function n(t,n){return{type:"click",startMouse:t,startScale:n,manipulator:e.manipulator(t,n)}}var a=d3.behavior.zoom().on("zoomstart",(function(){t=t||n(d3.mouse(this),a.scale())})).on("zoom",(function(){var e=d3.mouse(this),a=d3.event.scale;if("click"===(t=t||n(e,1)).type||"spurious"===t.type){var o=µ.distance(e,t.startMouse);if(a===t.startScale&&o<4)return void(t.type=o>0?"click":"spurious");r.trigger("moveStart"),t.type="drag"}a!=t.startScale&&(t.type="zoom"),t.manipulator.move("zoom"===t.type?null:e,a),r.trigger("move")})).on("zoomend",(function(){t.manipulator.end(),"click"===t.type?r.trigger("click",t.startMouse,e.projection.invert(t.startMouse)||[]):"spurious"!==t.type&&o(),t=null})),o=_.debounce((function(){(!t||"drag"!==t.type&&"zoom"!==t.type)&&(f.save({orientation:e.orientation()},{source:"moveEnd"}),r.trigger("moveEnd"))}),1e3);function i(){var t=arguments[3]||{};e&&"moveEnd"!==t.source&&(r.trigger("moveStart"),e.orientation(f.get("orientation"),s),a.scale(e.projection.scale()),r.trigger("moveEnd"))}d3.select("#display").call(a),d3.select("#show-location").on("click",(function(){navigator.geolocation&&(d.status("Finding current position..."),navigator.geolocation.getCurrentPosition((function(t){d.status("");var n=[t.coords.longitude,t.coords.latitude],a=e.locate(n);a&&(e.projection.rotate(a),f.save({orientation:e.orientation()})),r.trigger("click",e.projection(n),n)}),c.error))}));var r=_.extend({globe:function(t){return t&&(e=t,a.scaleExtent(e.scaleExtent()),i()),t?this:e}},Backbone.Events);return r.listenTo(f,"change:orientation",i)}(),g=u(),p=u(),m=u(),h=u(),y=u(),b=u(),w=u();function k(e){var t=this.cancel;return d.status("Downloading..."),µ.loadJson(e).then((function(e){if(t.requested)return null;c.time("building meshes");var n=e.objects,a=topojson.feature(e,µ.isMobile()?n.coastline_tiny:n.coastline_110m),o=topojson.feature(e,µ.isMobile()?n.coastline_110m:n.coastline_50m),i=topojson.feature(e,µ.isMobile()?n.lakes_tiny:n.lakes_110m),r=topojson.feature(e,µ.isMobile()?n.lakes_110m:n.lakes_50m);return c.timeEnd("building meshes"),{coastLo:a,coastHi:o,lakesLo:i,lakesHi:r}}))}function x(e){var t=globes.get(e);return t?when(t(s)):when.reject("Unknown projection: "+e)}var T=0;function M(){d.status("Downloading..."),c.time("build grids");var e=this.cancel;T++;var t=when.map(products.productsFor(f.attributes),(function(t){return t.load(e)}));return when.all(t).then((function(e){return c.time("build grids"),{primaryGrid:e[0],overlayGrid:e[1]||e[0]}})).ensure((function(){T--}))}function G(e){if(T>0)c.debug("Download in progress--ignoring nav request.");else{var t=m.value().primaryGrid.navigate(e);t&&f.save(µ.dateToConfig(t))}}function E(e,t){if(!e||!t)return null;d.status("Rendering Globe..."),c.time("rendering map");var n=_.clone(Backbone.Events);h._previous&&h._previous.stopListening(),h._previous=n,µ.removeChildren(d3.select("#map").node()),µ.removeChildren(d3.select("#foreground").node()),t.defineMap(d3.select("#map"),d3.select("#foreground"));var a=d3.geo.path().projection(t.projection).pointRadius(7),o=d3.select(".coastline"),i=d3.select(".lakes");function r(e,t){if((!y.value()||y.value().isInsideBoundary(e[0],e[1]))&&t&&_.isFinite(t[0])&&_.isFinite(t[1])){var n=d3.select(".location-mark");n.node()||(n=d3.select("#foreground").append("path").attr("class","location-mark")),n.datum({type:"Point",coordinates:t}).attr("d",a)}}d3.selectAll("path").attr("d",a),N.point&&N.coord&&r(N.point,N.coord);var l=_.throttle((function e(){d3.selectAll("path").attr("d",a),h.trigger("redraw"),l=_.throttle(e,5,{leading:!1})}),5,{leading:!1});return n.listenTo(v,{moveStart:function(){o.datum(e.coastLo),i.datum(e.lakesLo),h.trigger("start")},move:function(){l()},moveEnd:function(){o.datum(e.coastHi),i.datum(e.lakesHi),d3.selectAll("path").attr("d",a),h.trigger("render")},click:r}),when(!0).then((function(){v.globe(t)})),c.timeEnd("rendering map"),"ready"}function C(e,t,n,a,o,i,r){var l=r[0]*i,s=r[1]*i,c=µ.distortion(e,t,n,a,o);return r[0]=c[0]*l+c[2]*s,r[1]=c[1]*l+c[3]*s,r}function D(e,t){if(!e||!t)return null;var n=function(e){if(!e)return null;c.time("render mask");var t=s.width,n=s.height,a=d3.select(document.createElement("canvas")).attr("width",t).attr("height",n).node(),o=e.defineMask(a.getContext("2d"));o.fillStyle="rgba(255, 0, 0, 1)",o.fill();var i=o.getImageData(0,0,t,n),r=i.data;return c.timeEnd("render mask"),{imageData:i,isVisible:function(e,n){return r[4*(n*t+e)+3]>0},set:function(e,n,a){var o=4*(n*t+e);return r[o]=a[0],r[o+1]=a[1],r[o+2]=a[2],r[o+3]=a[3],this}}}(e),l=t.primaryGrid,u=t.overlayGrid;c.time("interpolating field");var f=when.defer(),v=this.cancel,g=e.projection,p=e.bounds(s),m=p.height*l.particles.velocityScale,h=[],y=[],b=p.x,w=l.interpolate,k=u.interpolate,x=l!==u,T=u.scale;function M(e){for(var t=[],o=p.y;o<=p.yMax;o+=2)if(n.isVisible(e,o)){y[0]=e,y[1]=o;var l=g.invert(y),s=r,c=null;if(l){var d=l[0],u=l[1];if(isFinite(d)){var f=null;(c=w(d,u))&&(f=(c=C(g,d,u,e,o,m,c))[2]),x&&(f=k(d,u)),µ.isValue(f)&&(s=T.gradient(f,a))}}t[o+1]=t[o]=c||i,n.set(e,o,s).set(e+1,o,s).set(e,o+1,s).set(e+1,o+1,s)}h[e+1]=h[e]=t}return d.status(""),function e(){try{if(!v.requested)for(var t=Date.now();b<p.xMax;)if(M(b),b+=2,Date.now()-t>100)return d.progress((b-p.x)/(p.xMax-p.x)),void setTimeout(e,25);f.resolve(function(e,t,n){function a(t,n){var a=e[Math.round(t)];return a&&a[Math.round(n)]||o}return a.isDefined=function(e,t){return null!==a(e,t)[2]},a.isInsideBoundary=function(e,t){return a(e,t)!==o},a.release=function(){e=[]},a.randomize=function(e){var n,o,i=0;do{n=Math.round(_.random(t.x,t.xMax)),o=Math.round(_.random(t.y,t.yMax))}while(!a.isDefined(n,o)&&i++<30);return e.x=n,e.y=o,e},a.overlay=n.imageData,a}(h,p,n))}catch(e){f.reject(e)}d.progress(1),c.timeEnd("interpolating field")}(),f.promise}function j(e,t,n){if(e&&t&&n){var a=this.cancel,o=e.bounds(s),i=µ.windIntensityColorScale(10,n.primaryGrid.particles.maxIntensity),r=i.map((function(){return[]})),l=Math.round(7*o.width);µ.isMobile()&&(l*=.75);var u=µ.isFF()?"rgba(0, 0, 0, 0.95)":"rgba(0, 0, 0, 0.97)";c.debug("particle count: "+l);for(var f=[],v=0;v<l;v++)f.push(t.randomize({age:_.random(0,100)}));var g=d3.select("#animation").node().getContext("2d");g.lineWidth=1,g.fillStyle=u,function e(){try{if(a.requested)return void t.release();r.forEach((function(e){e.length=0})),f.forEach((function(e){e.age>100&&(t.randomize(e).age=0);var n=e.x,a=e.y,o=t(n,a),l=o[2];if(null===l)e.age=100;else{var s=n+o[0],c=a+o[1];t.isDefined(s,c)?(e.xt=s,e.yt=c,r[i.indexFor(l)].push(e)):(e.x=s,e.y=c)}e.age+=1})),n=g.globalCompositeOperation,g.globalCompositeOperation="destination-in",g.fillRect(o.x,o.y,o.width,o.height),g.globalCompositeOperation=n,r.forEach((function(e,t){e.length>0&&(g.beginPath(),g.strokeStyle=i[t],e.forEach((function(e){g.moveTo(e.x,e.y),g.lineTo(e.xt,e.yt),e.x=e.xt,e.y=e.yt})),g.stroke())})),setTimeout(e,40)}catch(e){d.error(e)}var n}()}}function S(e,t){if(e){var n=d3.select("#overlay").node().getContext("2d"),a=(m.value()||{}).overlayGrid;if(µ.clearCanvas(d3.select("#overlay").node()),µ.clearCanvas(d3.select("#scale").node()),t&&("off"!==t&&n.putImageData(e.overlay,0,0),function(e,t,n){if(t&&n&&f.get("showGridPoints")){e.fillStyle="rgba(0, 0, 0, 1)";var a=n.projection.stream({point:function(t,n){e.fillRect(Math.round(t),Math.round(n),1,1)}});t.forEachPoint((function(e,t,n){µ.isValue(n)&&a.point(e,t)}))}}(n,a,p.value())),a){for(var o=d3.select("#scale"),i=a.scale,r=i.bounds,l=o.node(),s=l.getContext("2d"),c=l.width-1,d=0;d<=c;d++){var u=i.gradient(µ.spread(d/c,r[0],r[1]),1);s.fillStyle="rgb("+u[0]+","+u[1]+","+u[2]+")",s.fillRect(d,0,1,l.height)}o.on("mousemove",(function(){var e=d3.mouse(this)[0],t=µ.clamp((Math.round(e)-2)/(c-2),0,1),n=µ.spread(t,r[0],r[1]),i=z("wind"===a.type?"#location-wind-units":"#location-value-units",a).value();o.attr("title",µ.formatScalar(n,i)+" "+i.label)}))}}}function F(e){var t=new Date(function(e){var t=108e5,n=e?e.primaryGrid.date.getTime():Math.floor(Date.now()/t)*t,a=f.get("date").split("/"),o=f.get("hour");return a.length>1?Date.UTC(+a[0],a[1]-1,+a[2],+o.substring(0,2)):"current"===a[0]?n:null}(e)),n=d3.select("#data-date").classed("local"),a=n?µ.toLocalISO(t):µ.toUTCISO(t);d3.select("#data-date").text(a+" "+(n?"Local":"UTC")),d3.select("#toggle-zone").text("⇄ "+(n?"UTC":"Local"))}function I(e){F(e);var t="",n="";if(e){var a=d3.select("body").attr("data-lang")||"en",o=e.primaryGrid.description(a),i=e.overlayGrid.description(a);t=i.name+i.qualifier,e.primaryGrid!==e.overlayGrid&&(t=(o.qualifier===i.qualifier?o.name:o.name+o.qualifier)+" + "+t),n=e.overlayGrid.source}d3.select("#data-layer").text(t),d3.select("#data-center").text(n)}function z(e,t){var n=t.units,a=n.length,o=+(d3.select(e).attr("data-index")||0)%a;return{value:function(){return n[o]},next:function(){d3.select(e).attr("data-index",o=(o+1)%a)}}}function q(e,t){var n=z("#location-wind-units",t),a=n.value();d3.select("#location-wind").text(µ.formatVector(e,a)),d3.select("#location-wind-units").text(a.label).on("click",(function(){n.next(),q(e,t)}))}function A(e,t){var n=z("#location-value-units",t),a=n.value();d3.select("#location-value").text(µ.formatScalar(e,a)),d3.select("#location-value-units").text(a.label).on("click",(function(){n.next(),A(e,t)}))}var N={};function P(e,t){e=e||[],t=t||[];var n=m.value(),a=y.value(),o=t[0],i=t[1];if(a&&a.isInsideBoundary(e[0],e[1])&&(H(!1),N={point:e,coord:t},_.isFinite(o)&&_.isFinite(i)&&(d3.select("#location-coord").text(µ.formatCoordinates(o,i)),d3.select("#location-close").classed("invisible",!1)),a.isDefined(e[0],e[1])&&n)){var r=n.primaryGrid.interpolate(o,i);if(µ.isValue(r)&&q(r,n.primaryGrid),n.overlayGrid!==n.primaryGrid){var l=n.overlayGrid.interpolate(o,i);µ.isValue(l)&&A(l,n.overlayGrid)}}}function L(){P(N.point,N.coord)}function H(e){d3.select("#location-coord").text(""),d3.select("#location-close").classed("invisible",!0),d3.select("#location-wind").text(""),d3.select("#location-wind-units").text(""),d3.select("#location-value").text(""),d3.select("#location-value-units").text(""),e&&(N={},d3.select(".location-mark").remove())}function V(e){b.cancel(),e&&µ.clearCanvas(d3.select("#animation").node())}function O(e,t,n){n=n||_.keys(t),d3.select(e).on("click",(function(){d3.select(e).classed("disabled")||f.save(t)})),f.on("change",(function(a){var o=a.attributes;d3.select(e).classed("highlighted",_.isEqual(_.pick(o,n),_.pick(t,n)))}))}function B(e){ga&&ga("send","event","sponsor",e)}when(!0).then((function(){d.status("Initializing..."),d3.select("#sponsor-link").attr("target",µ.isEmbeddedInIFrame()?"_new":null).on("click",B.bind(null,"click")).on("contextmenu",B.bind(null,"right-click")),d3.select("#sponsor-hide").on("click",(function(){d3.select("#sponsor").classed("invisible",!0)})),d3.selectAll(".fill-screen").attr("width",s.width).attr("height",s.height);var e=d3.select("#scale-label").node();function t(){h.submit(E,g.value(),p.value())}function n(){y.submit(D,p.value(),m.value())}function a(){y.cancel()}d3.select("#scale").attr("width",.97*(d3.select("#menu").node().offsetWidth-e.offsetWidth)).attr("height",e.offsetHeight/2),d3.select("#show-menu").on("click",(function(){µ.isEmbeddedInIFrame()?window.open("http://earth.nullschool.net/"+window.location.hash,"_blank"):d3.select("#menu").classed("invisible",!d3.select("#menu").classed("invisible"))})),µ.isFF()&&d3.select("#display").classed("firefox",!0),"ontouchstart"in document.documentElement?d3.select(document).on("touchstart",(function(){})):d3.select(document.documentElement).classed("no-touch",!0),d3.select(window).on("hashchange",(function(){c.debug("hashchange"),f.fetch({trigger:"hashchange"})})),f.on("change",d.reset),g.listenTo(f,"change:topology",(function(e,t){g.submit(k,t)})),p.listenTo(f,"change:projection",(function(e,t){console.log(t),p.submit(x,t)})),m.listenTo(f,"change",(function(){var e=_.keys(f.changedAttributes()),t=!1;_.intersection(e,["date","hour","param","surface","level"]).length>0&&(t=!0);var n=f.get("overlayType")||"default";if(_.indexOf(e,"overlayType")>=0&&"off"!==n){var a=m.value()||{},o=a.primaryGrid,i=a.overlayGrid;i&&(i.type===n||"default"===n&&o===i)||(t=!0)}t&&m.submit(M)})),m.on("submit",(function(){I(null)})),m.on("update",(function(e){I(e)})),d3.select("#toggle-zone").on("click",(function(){d3.select("#data-date").classed("local",!d3.select("#data-date").classed("local")),F(m.cancel.requested?null:m.value())})),h.listenTo(g,"update",t),h.listenTo(p,"update",t),y.listenTo(m,"update",n),y.listenTo(h,"render",n),y.listenTo(h,"start",a),y.listenTo(h,"redraw",a),b.listenTo(y,"update",(function(e){b.submit(j,p.value(),e,m.value())})),b.listenTo(h,"start",V.bind(null,!0)),b.listenTo(m,"submit",V.bind(null,!1)),b.listenTo(y,"submit",V.bind(null,!1)),w.listenTo(y,"update",(function(){w.submit(S,y.value(),f.get("overlayType"))})),w.listenTo(h,"start",(function(){w.submit(S,y.value(),null)})),w.listenTo(f,"change",(function(){var e=_.keys(f.changedAttributes());_.intersection(e,["overlayType","showGridPoints"]).length>0&&w.submit(S,y.value(),f.get("overlayType"))})),v.on("click",P),y.on("update",L),d3.select("#location-close").on("click",_.partial(H,!0)),f.on("change:param",(function(e,t){switch(d3.selectAll(".ocean-mode").classed("invisible","ocean"!==t),d3.selectAll(".wind-mode").classed("invisible","wind"!==t),t){case"wind":d3.select("#nav-backward-more").attr("title","-1 Day"),d3.select("#nav-backward").attr("title","-3 Hours"),d3.select("#nav-forward").attr("title","+3 Hours"),d3.select("#nav-forward-more").attr("title","+1 Day");break;case"ocean":d3.select("#nav-backward-more").attr("title","-1 Month"),d3.select("#nav-backward").attr("title","-5 Days"),d3.select("#nav-forward").attr("title","+5 Days"),d3.select("#nav-forward-more").attr("title","+1 Month")}})),d3.select("#wind-mode-enable").on("click",(function(){"wind"!==f.get("param")&&f.save({param:"wind",surface:"surface",level:"level",overlayType:"default"})})),f.on("change:param",(function(e,t){d3.select("#wind-mode-enable").classed("highlighted","wind"===t)})),d3.select("#ocean-mode-enable").on("click",(function(){if("ocean"!==f.get("param")){var e={param:"ocean",surface:"surface",level:"currents",overlayType:"default"},t=_.clone(f.attributes);"current"===t.date?f.save(e):when.all(products.productsFor(_.extend(t,e))).spread((function(t){t.date&&f.save(_.extend(e,µ.dateToConfig(t.date)))})).otherwise(d.error),V(!0)}})),f.on("change:param",(function(e,t){d3.select("#ocean-mode-enable").classed("highlighted","ocean"===t)})),f.on("change:overlayType",(function(e,t){d3.select("#surface-level").classed("disabled","air_density"===t||"wind_power_density"===t)})),f.on("change:surface",(function(e,t){d3.select("#overlay-air_density").classed("disabled","surface"===t),d3.select("#overlay-wind_power_density").classed("disabled","surface"===t)})),d3.select("#nav-backward-more").on("click",G.bind(null,-10)),d3.select("#nav-forward-more").on("click",G.bind(null,10)),d3.select("#nav-backward").on("click",G.bind(null,-1)),d3.select("#nav-forward").on("click",G.bind(null,1)),d3.select("#nav-now").on("click",(function(){f.save({date:"current",hour:""})})),d3.select("#option-show-grid").on("click",(function(){f.save({showGridPoints:!f.get("showGridPoints")})})),f.on("change:showGridPoints",(function(e,t){d3.select("#option-show-grid").classed("highlighted",t)})),d3.selectAll(".surface").each((function(){var e=this.id,t=e.split("-");O("#"+e,{param:"wind",surface:t[0],level:t[1]})})),O("#animate-currents",{param:"ocean",surface:"surface",level:"currents"}),products.overlayTypes.forEach((function(e){O("#overlay-"+e,{overlayType:e})})),O("#temp-temp",{overlayType:"temp"}),O("#temp-wind",{overlayType:"wind"}),O("#overlay-wind",{param:"wind",overlayType:"default"}),O("#overlay-ocean-off",{overlayType:"off"}),O("#overlay-currents",{overlayType:"default"}),globes.keys().forEach((function(e){O("#"+e,{projection:e,orientation:""},["projection"])})),d3.select(window).on("orientationchange",(function(){s=µ.view(),p.submit(x,f.get("projection"))}))})).then((function(){f.fetch()})).otherwise(d.error)}();